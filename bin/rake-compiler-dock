#!/usr/bin/env ruby

require 'rake_compiler_dock'

pwd = Dir.pwd
uid = Process.uid
gid = Process.gid
user = `id -nu`.chomp
group = `id -ng`.chomp
args = ARGV.empty? ? ['bash'] : ARGV
image = ENV['RAKE_COMPILER_DOCK_IMAGE'] || "larskanis/rake-compiler-dock:#{RakeCompilerDock::VERSION}"

cmd = ["docker", "run", "--rm", "-i", "-t",
       "-v", "#{pwd}:#{pwd}",
       "-e", "UID=#{uid}",
       "-e", "GID=#{gid}",
       "-e", "USER=#{user}",
       "-e", "GROUP=#{group}",
       "-w", pwd,
       image,
       "sigfw", "runas", *args]

puts cmd.join(" ")
system *cmd
